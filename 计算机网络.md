# 互联网的边缘部分
> 处于互联网边缘的部分就是连接在互联网上的所有的主机，这些主机又称为端系统。

## 网络边缘的端系统之间的通信方式可划分为：
1. 客户-服务器方式
- 客户程序：被用户调用后运行，在通信是主动向远程服务器发起通信，客户程序必须知道服务器程序的地址；不需要特殊的硬件和很复杂的操作系统。
- 服务器程序：是一种专门用来提供某种服务的程序，可同时处理多个远程或本地客户的请求；系统启动后即自动调用并一直不断地运行着，被动地等待并接受来自各地的客户通信请求，服务器程序不需要知道客户程序的地址；需要有强大的硬件和高级的操作系统支持。
2. 对等连接方式
> 即P2P方式

安装了p2p软件的主机，双方可以进行平等的、对等连接通信。从本质上仍然是使用C/S方式，只不过每一台主机可以看做既是客户又同时是服务器。

# 互联网的核心部分
> 是互联网中最复杂的部分，要向网络边缘中的大量主机提供连通性，使边缘部分中的任何一台主机都能够向其他主机通信。

- **路由器**,是一种专用计算机。它是实现**分组交换**的关键构件，其任务是转发收到的分组，这是网络核心部分最重要的功能。

- 电路交换



# 1. 计算机网络体系结构
> OSI实际上没有得到广泛应用，TCP/IP是事实上的国际标准

| OSI七层协议 | TCP/IP体系结构     | 五层协议体系结构 |
| ----------- | ------------------ | ---------------- |
| 应用层      | 应用层             | 应用层           |
| 表示层      | 应用层             | 应用层           |
| 会话层      | 应用层             | 应用层           |
| 运输层      | 运输层（TCP或UDP） | 运输层           |
| 网络层      | 网际层 IP          | 网络层           |
| 数据链路层  | 网络接口层         | 数据链路层       |
| 物理层      | 网络接口层         | 物理层           |

| 体系结构   | 数据                                                    |
| ---------- | ------------------------------------------------------- |
| 应用层     | 报文                                                    |
| 运输层     | 报文段（TCP），用户数据报（UDP）                        |
| 网络层     | 称作分组（TCP）或包 (UDP) 分组也叫 IP数据报，简称数据报 |
| 数据链路层 | 帧                                                      |
| 物理层     | 比特                                                    |

# 2. 物理层

# 3. 数据链路层
> 重点：（1） 数据链路层点对点信道和广播信道的特点，以及这两种信道所使用的协议（PPP协议以及CSMA/CD协议）的特点。（2）数据链路层的三个基本问题：封装成帧、透明传输和差错检测。（3）以太网MAC层的硬件地址。（4）适配器、转发器、集线器、网桥、以太网交换机的作用以及使用场合。

## 3.1 使用点对点信道的数据链路层

### 3.1.1 数据链路和帧

**链路** 从一个结点到相邻结点的一段物理线路（有线或无线），而中间没有任何其他的交换结点。

**数据链路** 包括一段物理线路之外，还必须有必要的通信协议来控制这些数据的传输

**帧** 点对点信道的数据链路层的协议数据单元

点对点信道的数据链路层
![image](https://pic1.superbed.cn/item/5e00213e76085c328994796c.jpg)

### 3.1.2 三个基本问题

1. 封装成帧

 ![image](https://pic2.superbed.cn/item/5e002bd976085c32899838a1.jpg)
2. 透明传输 

 帧开始和结束的标记使用专门指明的控制字符，因此，所传输的数据中的任何8比特的组合一定不允许和用作帧定界的控制字符的比特编码一样，否则会出现帧定界的错误。
 ![image](https://pic3.superbed.cn/item/5e002da876085c3289987641.jpg)

 解决方法
 ![image](https://pic1.superbed.cn/item/5e002e2476085c328998a73d.jpg)

 3. 差错检测
 **比特差错** 是传输差错中的一种，在传输过程中可能会出现1变成0，0变成1的差错。
传输错误的比特占所传输比特总数的比率称为**误码率**。误码率与信噪比有很大关系，误码是不可避免的。

**循环冗余检验CRC** 在数据链路层被广泛使用。发送端帧检验序列FCS的生成和接收端的CRC检验都是用硬件完成，处理很迅速，并不会延误数据的传输。

发送端CRC运算后在数据M的后面添加提供差错校验的n位冗余码，然后构成一个帧发送出去，这种为了检错而添加的冗余码常称为**帧检验序列FCS**。计算冗余码和CRC检验都是用相同的除数P进行模二运算。通过检错的帧我们可以认为均无差错。

## 3.2 点对点协议PPP
> PPP协议是用户计算机和ISP进行通信时所使用的数据链路层协议

1. PPP协议应满足的需求

- 简单,不需要纠错，不需要序号，不需要流量控制。
- 封装成帧，必须规定特殊的字符作为帧定界符。
- 透明性，当数据中碰巧出现了和帧定界符一样的比特组合时，能够才取有效的措施解决这个问题。
- 支持多种网络层协议的运行
- 多种类型链路的支持，如串行的并行的同步异步低速高速电的光的动态的静态的点对点链路。
- 差错检测
- 检测连接状态
- 设置最大传送单元的默认值
- 网络层地址协商，必须提供一种机制使通信的两个网络层实体能够配置彼此的网络层地址。
- 必须提供数据压缩协商，不要求将压缩算法标准化
PPP协议不支持多点线路，只支持点对点的链路通信，此外，PPP协议只支持全双工链路。

2. PPP协议的组成
 - 一个将IP数据报封装到串行链路的方法。PPP既支持异步链路（无奇偶检验的8比特数据）也支持面向比特的同步链路。
 - 一个用来建立、配置和测试数据链路连接的链路控制协议LCP
 - 一套网络控制协议NCP，其中的每一个协议支持不同的网络层协议，如IP、DECnet,AppleTalk

### 3.2.2 PPP协议的帧格式

1. 各字段的意义
 ![image](https://pic1.superbed.cn/item/5e00a65376085c3289d1efd7.jpg)
> 连续的两帧之间只需要用一个标志字段，如果出现连续的两个标志字段，就表示一个空帧。应当丢弃。

F规定为0x7E表示一个帧的开始或者结束即定界符
；A规定为0xFF,控制字段C规定为0x03，这两个字段曾考虑以后进行其他定义，但至今也没有给出，实际上并没有携带PPP帧的信息。首部的第四个字段是2字节的协议字段。0x0021，表示信息字段就是IP数据报，0xC021，信息字段是链路控制协议LCP的数据，0x8021表示网络层的控制数据

2. 字节填充
当PPP使用异步传输时，它把转义符定义为0x7D，并使用字节填充：
- 把信息字段中出现的每一个0x7E字节转变为2字节序列（0x7D,0x5E）
- 若信息字段中出现一个0x7D的字节（出现了和转义字符一样的比特组合），则把0x7D转变成为2字节序列（0x7D,0x5D）。
- 若信息中出现ASCII码控制字符（即数值小于0x20的字符），则在该字符前面加入一个0x7D字节，同时该字符的编码要加以改变，如 0x03 转成 （0x7D，0x23）

发送端进行了字节填充，因此在链路上传送的信息字节数就超过了原来的信息，接收端进行与发送端相反的变化就可以正确地恢复出原来的信息。

3. 零比特填充
> PPP协议用在SONET/SDH链路时，使用同步传输（一连串的比特连续传送）而不是异步传输（逐个字符地传送）。这时采用零比特填充方法来实现透明传输。

零比特传输的具体做法：在发送端，先扫描整个信息字段。只要发现有5个连续的1，则立即填入一个0，经过这种处理，就可以保证在信息字段中不会出现6个连续的1。接收端，收到一个帧时，先找到标志字段F以确定一个帧的边界，接着扫描之后的比特流，每当发现5个连续的1时，就把这5个连续1后的一个0删除，以还原成原来的信息比特流。这样保证了不会引起对帧边界的错误判断。
![image](https://pic1.superbed.cn/item/5e00d5e076085c3289ec5a77.jpg)

### 3.2.3 PPP协议的工作状态

![image](https://pic.superbed.cn/item/5e01881576085c328959f2ae.jpg)
由此可见，PPP协议已不是纯粹的数据链路层的协议，还包含了物理层和网络层的内容

## 3.3 使用广播信道的数据链路层
> 广播信道进行一对多的通信。局域网使用的就是广播信道,局域网技术在计算机网络中占有非常重要的地位。

### 3.3.1 局域网的数据链路层
> 局域网的主要特点是：网络为一个单位所拥有，且地理范围和站点数目均有限。

1. 局域网的主要优点：
- 具有广播功能，从一个站点可以访问全网。局域网上的主机可以共享连接在局域网上的各种硬件和软件资源。
- 便于系统的扩展和逐渐演变，各设备的位置可灵活调整改变。
- 提高了系统的可靠性、可用性和稳定性

**以太网** 是一种计算机局域网技术，现在广泛被使用，使用动态媒体随机接入控制。
随机接入的特点是所有用户可随机地发送信息，若恰巧有两个或更多的用户在同一时刻发送消息，那么在共享媒体上就要产生碰撞（冲突），使得这些用户的发送都失败，这时要有解决碰撞的网络协议。 

2. 适配器的作用

 适配器和局域网之间的通信是通过电缆或双绞线以串行传输方式进行的，而适配器和计算机之间的通信则是通过计算机主板上的I/O总线并行传输的，适配器的一个重要功能就是要进行数据串行传输和并行传输的转换。

 适配器上面装有处理器和存储器（包括RAM和ROM）,为了对数据进行缓冲，因为网络上的数据和计算机总线上的数据率并不相同，接收和发送各种帧时，不使用计算机的CPU。
 计算机的硬件地址就在适配器的ROM中，计算机的软件地址——IP地址，在计算机的存储器中。

 ![image](https://pic1.superbed.cn/item/5e01bf5176085c3289661afd.jpg)


 ### 3.3.2 CSMA/CD 协议

> 最早的以太网是将许多计算机都连接到一根总线上。总线的特点是：当一台计算机发送数据时，总线上的所有计算机都能检测到这个数据，这种就是广播通信的方式。为了实现一对一通信，需要写明接收站适配器的地址。而在同一时间只能允许一台计算机发送数据。

为了通信的简便采用了两种措施：
- 采用了较为灵活的无连接的工作方式，即不必先建立连接就可以直接发送数据。适配器对发送的数据不进行编号，也不要求对方发回确认。因此,与以太网提供的服务是尽最大努力的交付，即不可靠的交付。对有差错帧是否需要重传则由高层决定，但以太网并不知道这是重传帧，而是当作新的数据帧来发送。
- 以太网发送的数据都是用曼彻斯特编码的信号。这样接收端利用电压的转换很方便地把位同步信号提取出来。

CSMA/CD 意思是载波监听多点接入/碰撞检测。为了协调各总线上的计算机的工作。计算机需要保持对信道空闲的监听，待发送数据时，信道空闲才可以发送，否则继续等待一段随机时间。

CSMA/CD 协议的要点：

- 多点接入 许多计算机以多点接入的方式连接在一根总线上。
- 载波监听 用电子技术检测总线上有没有其他计算机也在发送。不管在发送前还是发送中，每个站都必须不停地检测信道。
- 碰撞检测 几个站同时发送数据时，总线上的信号电压变化幅度将会增大。当适配器检测到的信号电压变化幅度超过阈值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞。

由于电磁波在总线有传播时延，数据会出现总线上的碰撞。最多是两倍的总线端到端的传播时延才能知道发送的数据和其他站发送的数据产生了碰撞。因而使用CSMA/CD协议的以太网不可能进行全双工通信而只能进行半双工通信。

每一个站在自己发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。以太网使用**截断二进制指数退避**算法来确定碰撞后的重传的时机。这样是为了减少再次碰撞的可能。 

可以把CSMA/CD协议的要点归纳如下:
(1)准备发送:适配器从网络层获得-一个分组，加上以太网的首部和尾部，组成以太网帧，放入适配器的缓存中。但在发送之前，必须先检测信道。
(2)检测信道:若检测到信道忙，则应不停地检测，一直 等待信道转为空闲。若检测到
信道空闲，并在96比特时间内信道保持空闲(保证了帧间最小间隔)，就发送这个帧。
(3)在发送过程中仍不停地检测信道，即网络适配器要边发送边监听。这里只有两种可
能性:
①发送成功:在争用期内-直未检测到碰撞。这个帧肯定能够发送成功。发送完毕
后，其他什么也不做。然后回到(1)。
②发送失败:在争用期内检测到碰撞。这时立即停止发送数据，并按规定发送人为干
扰信号。适配器接着就执行指数退避算法，等待r倍512 比特时间后，返回到步骤(2),继
续检测信道。但若重传达16次仍不能成功，则停止重传而向上报错。
以太网每发送完一帧，一定要把已发送的帧暂时保留一下。如果在争用期内检测出发
生了碰撞，那么还要在推迟一段时间后再把这个暂时保留的帧重传一次。

### 3.3.3 使用集线器的星型拓扑

![image](https://pic2.superbed.cn/item/5e0317f276085c3289ff297d.jpg)

集线器的特点：
(1) 使用集线器的以太网在逻辑上仍是一个总线网，各站共享逻辑上的总线，使用的还是CSMA/CD协议，网络中的各站必须竞争对传输媒体的控制，并且在同一时刻至多允许一个站发送数据。
(2) 一个集线器有许多接口。通过RJ-45插头用两对双绞线与一台计算机上的适配器相连
(3) 集线器工作在物理层，接口简单地转发比特，不进行碰撞检测。
(4) 集线器采用专门的芯片，进行自适应的串音回波抵消。这样就可是接口转发出去的较强信号不致对该接口收到的较弱信号产生干扰。

# 4 网络层
 > - 虚拟互连网络
 > - IP地址与物理地址的关系
 > - 传统的分类的IP地址（包括子网掩码）和无分类域间路由选择CIDR
 > - 路由选择协议的工作原理


 **网络层提供的服务** 网络层向上只提供简单灵活、无连接、尽最大努力交付的数据报服务。网络层不提供服务质量的承诺


 ## 4.2 网际协议IP

![image](https://pic.downk.cc/item/5e0ed47a76085c32898551cf.jpg)


 ## 4.3 虚拟互连网络
 没有一种单一的网络能够适应所有用户的需求。由于参加互连的计算机网络都使用相同的网际协议IP，因此可以把互连以后的计算机网络看成是一个虚拟互连网络。互联网可以由多种异构网络互连组成。

 **中间设备**
1. 物理层使用的中间设备叫 **转发器** 
 2. 数据链路层使用的中间设备叫做 **网桥** 或 **桥接器**
 3. 网络层使用的中间设备叫 **路由器**
 4. 在网络层以上使用的中间设备叫 **网关**

 ### 4.2.2 分类的IP地址

IP地址的编制方法：
(1) 分类的IP地址。(2) 子网的划分。(3) 构成超网。

**分类的的IP地址**
**网络号**：标志着主机或者路由器所连接到的网络，一个网络号在整个互联网范围内必须是唯一的。**主机号**标志该主机或路由器，一台主机号在它前面的网络号所指明的网络范围内必须是唯一的。因而 IP地址在整个互联网范围内是唯一的。

![image](https://pic.downk.cc/item/5e0ef11076085c328989ac1f.jpg)

![image](https://pic.downk.cc/item/5e0ef7dd76085c32898ae269.jpg)

**重要特点**
1. 每一个IP地址都是由网络号和主机号两部分组成。
2. IP地址是标志一台主机或者为一条链路的接口。
3. 用转发器和网桥 （网络层以下的设备）连接起来的若干个局域网仍为一个网络。
4. 在IP地址中，所有分配到网络号的网络都是平等的。

### 4.2.3 IP地址与硬件地址 

**物理地址** 是数链路层和物理层使用的地址。
**IP地址** 是网络层和以上各层使用的地址，是一种逻辑地址，因为IP地址是用软件实现的。

1. 在IP抽象的互联网上只能看到IP数据报。
2. 路由器只根据目的站的IP地址的网络号进行路由选择。
3. 在局域网的链路层，只能看见MAC帧。
4. IP层抽象的互联网屏蔽了下层复杂的细节，在讨论网络层的问题上我们就可以使用统一的、抽象的IP地址研究主机或路由器之间的通信。

### 4.2.4 地址解析协议 ARP
 > 已知主机或路由器的IP地址,需要找出其相应的硬件地址。

 IP地址和硬件地址之间由于格式不同而不存在简单的映射关系，此外，IP地址具有动态性，更改主机会使IP地址变化和更换网络适配器会使硬件地址发生改变。因此每个主机设有**ARP高速缓存**，里面存放本局域网上的各主机和路由器的IP地址到硬件地址的映射表。


### 4.2.5 IP数据报的格式

![image](https://pic.downk.cc/item/5e12aba976085c3289fd33f2.jpg)

**最大传送单元MTU**。一个IP数据报的总长度一定不能超过数据链路层所规定的MTU值。最常用的以太网规定MTU值为1500字节。若所传送的数据报长度超过数据链路层的MTU值，就必须把过长的数据报进行分片处理。

### 4.2.6 IP层转发分组的流程
> 在互联网上转发分组时，是从一个路由器转发到下一个路由器。在路由表中，对每一条路由最主要的是 **(目的网络地址，下一跳地址)**

- IP数据报最终一定可以找到目的主机所在目的网络上的路由器（可能需要多次的间接交付）。
- 只有到达最后一个路由器时，才试图向目的主机进行直接交付。

**分组转发算法** 

1. 从数据报的首部提取目的主机的IP地址D，得出目的网络地址为N。
2. 若N就是与此路由器直接相连的某个网络地址，则进行直接交付，否则就是间接交付，执行3
3. 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器，否则，执行4.
4. 若路由表中有到达网络N的路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行5
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器，否则，执行6
6. 报告转发分组出错。



## 4.3 划分子网和构造超网

### 4.3.1 划分子网



> 1. IP地址空间的利用率有时很低；2. 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。3. 两级地址不够灵活。


 **划分子网**  在IP地址中增加一个  **子网号字段** ，使两级IP地址变成三级IP地址。

基本思路： 

1. 一个拥有许多物理网络的单位，可将所属的物理网络划分为若干个子网。 本单位以外的网络看不见这个网络是由多少个子网组成，因为这个单位对外仍然表现为一个网络。

2. 从网络的主机号借用若干位作为**子网号**，主机号也相应减少了同样的位数，用一下记法来表示三级IP地址。

   **IP地址 ::={<网络号>,<子网号>,<主机号>}**

3. 凡是从其他网络发送给本单位某台主机的IP数据报，仍然是根据IP数据报的目的网络号找到连接在本单位的网络上的路由器。但此路由器收到IP数据报后，再按目的网络号和子网号找到目的子网，把IP数据报交付目的主机。

   

当没有划分子网时，IP地址是两级结构。划分子网后IP地址变成了三级结构。划分子网把IP地址的主机号部分进行再划分，而不改变IP地址原来的网络号。

**子网掩码** 从IP地址划分子网 ，推荐在子网掩码中选用连续的1，以免出现可能发生的差错。不管网络有没有划分子网，通过和IP地址做“与”运算就可以得出网络地址。子网掩码是一个网络或一个子网的重要属性。两个路由器交换信息是，必须把自己所在网络的子网掩码告诉给相邻路由器。

无论是否划分子网，所有网络都必须使用子网掩码，路由器的路由表中也必须有子网掩码这一栏，如果一个网络不划分子网，那该网络的子网掩码就使用默认子网掩码。

**默认子网掩码**  1的位置和IP地址的中网络号字段net-id 正好相对应。因此，若用默认子网掩码 和某个不划分子网的IP地址逐位相与，就应当能够得出该IP地址的网络地址。A类地址的默认子网掩码 255.0.0.0 B类 255.255.0.0 C类255.255.255.0 。

划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。

同样的IP地址和不同的子网掩码可以得出相同的网络地址。

### 4.3.2 使用子网时分组的转发

子网划分后，路由表必须包含三项内容：目的网络地址、子网掩码和下一跳地址。

划分子网情况，路由器转发分组的算法如下：

1. 从收到的数据报的首部提取目的IP地址D。
2. 先判断是否为直接交付。对路由器直接相连的网络逐个进行检查：用各网络的子网掩码和D逐位相“与”，看结果是否和相应的网络地址匹配。匹配则直接交付，转发任务结束。否则就是间接交付，执行3
3. 若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器，否则执行4
4. 对路由表中的每一行，用其中的子网掩码和D逐位相与，其结果为N。若N与某行的目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器；否则，执行5
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则报告转发分组出错。

### 4.3.3 无分类编址 CIDR(构造超网)

1. 网络前缀

> B类IP地址殆尽；互联网主干网上的路由表中的项目数急剧增长；整个IPv4地址空间最终将全部耗尽。

使用**变长子网掩码VLSM** 可进一步提高IP地址资源的利用率。在VLSM的基础上研究出**无分类编址**方法，正式名字是**无分类域间路由选择CIDR** 

主要的特点

- CIDR 消除了传统A类、B类和C类地址以及划分子网的概念 ，能更加有效地分配IPv4的地址空间。并且在新的IPv6使用之前容许互联网的规模继续增长。采用两级编址，这是无分类的两级编址，记为：

​					**IP 地址 ::={<网络前缀>,<主机号>}**

还有一种**斜线记法**，在IP地址后面加上斜线，然后写上网络前缀所占的位数。

- CIDR 还把网络前缀相同的连续IP地址组成一个“CIDR地址块”。只要知道地址块中的任何一个地址，就可以知道起始地址和最大地址，以及地址块中的地址数。为了方便进行路由选择，以及兼容还使用子网划分和子网掩码的网络，CIDR使用32位的**地址掩码** ，地址掩码由一串1和0组成，1个个数为斜线记法的个数。

- **CIDR不使用子网** 是指CIDR并没有在32位地址中指明若干位作为子网字段。

- 斜线记法除了表示一个IP地址外，还提供了其他一些重要的信息。可以知道地址块包含的IP地址数量，地址块的最小地址和最大地址。

- **路由聚合** 在路由表中利用CIDR地址块来查找目的网络，使得路由表中的一个项目可以表示原来传统分类地址的很多个路由。也称为**构成超网**。

   路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。

   <img src="https://pic.downk.cc/item/5e43a5ce2fb38b8c3ccc3866.jpg" style="zoom:80%"/>

- 网络前缀越短，其地址块所包含的地址数就越多。
2. 最长前缀匹配

   > 采用网络前缀记法，IP地址由网络前缀和主机号这两个部分组成，此时路由表中项目由 网络前缀和下一跳地址组成。因而，在查找路由表时可能会得到不止一个匹配结果。

   应当从匹配结果中选择具有最长网络前缀的路由，这叫做最长前缀匹配。因为网络前缀越长，其地址块就越小，路由也就越具体。因为越具体的地址越接近于目的地址。

3. 使用二叉线索查找路由表
> 使用CIDR后，由于要寻找最长前缀匹配，使路由表的查找过程变得更加复杂。当路由表的项目数很大时，应当设法减小路由表的查找时间。

- 最简单的查找算法，对所有可能的前缀进行循环查找。这种方式效率低下，产生没有必要的查找次数。
- 最常用的是二叉线索查找，同时为了简化二叉线索的结构，可以先找出每一个IP地址的唯一前缀。这样就可以用唯一前缀来构造二叉线索，查找时，只要能够和唯一前缀相匹配就可以了。为了加快二叉线索的查找速度，广泛使用了各种压缩技术。如只要一个地址的前4位是1101，就可以跳过前面4位而直接从第5位开始比较。

## 4.4 网际控制报文协议 ICMP

> 为了更有效地转发IP数据报和提高交付成功的机会。

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。虽然ICMP报文在IP数据报的数据部分，但ICMP不是高层协议，而是IP层的协议。

![ICMP报文的格式](https://pic.downk.cc/item/5e43bd832fb38b8c3cd06c3d.jpg)

   ### 4.4.1 ICMP报文的种类

> ICMP差错报告报文和ICMP询问报文

常用的几种ICMP报文类型

![](https://pic.downk.cc/item/5e43c0462fb38b8c3cd0ebcc.jpg)

>  IP数据报首部的检验并不会检验IP数据报的内容，因此不能保证经过传输的ICMP报文不产生差错。

- 所有的ICMP差错报告报文中的数据字段都具有同样的格式。

![](https://pic.downk.cc/item/5e43dc1c2fb38b8c3cd58092.jpg)

把收到的需要进行差错报告的IP数据报的首部和数据字段的前8个字节提取出来，作为ICMP报文的数据字段，加上相应的ICMP差错报告报文的前8个字节，就构成了ICMP差错报告报文。提取收到数据报的数据字段的前8个字节是为了得到运输层的端口号，这些信息对源点通知高层协议是有用的。

### 4.4.2 ICMP的应用举例

- 分组网间探测 PING 。用来测试两台主机之间的连通性，使用了ICMP回送请求和回送回答报文。PING是应用层直接使用网络层ICMP的一个例子，它没有通过运输层的TCP或UDP。

- 用来跟踪一个分组从源点到终点的路径。 traceroute (UNIX系统)应用，tracert(windows系统)命令。 

  traceroute 从源主机向目的主机发送一连串的IP数据报，数据报中封装的是无法交付(使用了非法的端口号)的UDP用户数据报。通过设置不同的数据报生存时间TTL，当路由收到数据报TTL为零时，就把数据报丢弃，并向源主机发送一个ICMP时间超过的差错报告报文（若到达目的主机时则向源主机发送ICMP终点不可达差错报告报文）。就这样，这些路由器和最后的目的主机发来的ICMP报文正好给出了源主机想知道的路由信息。

  通过观察源点到终点的路由信息，完全有这样的可能：经过更多的路由器反而会花费更少的时间。因此，经过的路由数量与花费的时间并没有很大关系。

## 4.5 互联网的路由选择协议

### 4.5.1 有关路由选择协议的几个基本概念

1. 理想的路由算法

   1. 算法必须是正确的和完整的。
   2. 算法在计算上应简单。
   3. 算法应能适应通信量和网络拓扑的变化（自适应性和稳健性）
   4. 算法应具有稳定性
   5. 算法应是公平的
   6. 算法应是最佳的

2. 分层次的路由选择协议

   > 将整个互联网划分为许多较小的自治系统，记为AS(autonomous system)。AS是在单一技术管理下的一组路由器，这些路由器使用一种自治系统内部的路由选择协议和共同度量。一个AS对其他AS表现出的是一个单一的和一致的路由选择协议。

   这样，互联网就把路由选择协议划分为：**内部网关协议 IGP** 和 **外部网关协议 EGP** 。自治系统之间的路由选择叫域间路由选择，而在自治系统内部的路由选择叫做域内路由选择。

   ![](https://pic.downk.cc/item/5e44b22d48b86553eea77c34.jpg)

 

### 4.5.2 内部网关协议RIP

> 路由信息协议，是一种分布式的基于距离向量的路由选择协议。每一个路由器都要不断地和其他一些路由器交换路由信息。

1. 工作原理

   RIP协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录，**距离**也称跳数，每经过一个路由器跳数就加一。
   
   它只适用于小型的互联网，它认为好的路由就是它通过的路由器的数目少同时允许一个路径最多只能包含15个路由器。
   
   RIP协议的特点
   
   - 仅和相邻的路由器交换信息。
   - 交换的信息是当前本路由器所知道的全部信息，即自己现在的路由表。
   - 按固定的时间间隔交换路由信息。
   
2. 距离向量算法
> 要点：设X是结点A到B的最短路径上的一个结点。若把路径A->B 拆成 A->X 和 X

   RIP报文的所有项目

|  项目    | 符号     |
| ---- | ---- |
|  目的网络  | N     |
|  距离   |  d    |
| 下一跳路由器| X |

​			a. 对地址X的相邻路由器发来的RIP报文，先修改此报文中的所有项目： 下一跳地址的地址都改为X,并把所有的 距离字段的值加1。

​			b.  对发来的RIP修改后的每一个项目，进行判断和处理：

​					原路由表中没有目的网络N,则添加该条项目到路由表中。

​					否则，比对下一跳路由器地址

​							若为X,则更新替换原路由表的项目

​							若不为X且距离字段 d,小于路由表中的距离，更新。

​							否则 什么也不做

​			c. 3分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记作不可达。

3. RIP协议的报文格式

   ![](https://pic.downk.cc/item/5e475cd748b86553ee6a613b.jpg)

4. RIP主要的缺点：好消息传播得快，而当网络出现故障时坏消息传播得慢（30S）。

   最大优点：实现简单，开销较小。在网络规模较小的网络中，使用RIP协议仍占大多数。



### 4.5.3 内部网关协议 OSPF

> 开放最短路径优先 Open Shortest Path First，为了克服RIP的缺点开发出来。称为“最短路径优先”是因为使用了最短路径算法SPF。

1. 基本特点

   最主要的特征是使用分布式的链路状态协议，而不是像RIP的距离向量协议，有三个要点和RIP不同：

   - 向本自治系统中的所有路由器发送信息。使用 洪泛法，类似病毒式的感染传播。
   - 发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。
   - 只有当链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息。而RIP,不管网络拓扑有无变化，路由器之间都要定期交换路由表的信息。

   最终，所有的路由器都能建立一个链路状态数据库，实际上就是全网的拓扑结构图。因此，每一个路由器都知道全网所有路由器的信息。OSPF的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。OSPF的更新过程收敛快速是其重要的优点。

   **划分区域** OSPF将一个自治系统再划分为若干个更小的范围。这样把洪泛法交换链路状态信息的范围局限于每一个区域而不是整个自治系统，这样就减少了整个网络上的通信量。

![](https://pic.downk.cc/item/5e478acf48b86553ee71eeb4.jpg)

​		OSPF不同UDP而是直接用IP数据报传送，OSPF构成的数据报很短。这样可以减少通信量，也不必将长的的数据报分片传送。

![](https://pic.downk.cc/item/5e478c9a48b86553ee7244ac.jpg)

其他特点

- OSPF允许管理员给每条路由指派不同的代价。

- 如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫做多路径间的负载平衡。
- 所有在OSPF路由器之间交换的分组都具有鉴别的功能，可以保证仅在可信赖的路由器之间交换链路状态信息。
- OSPF支持可边长度的子网划分和无分类编址的CIDR。
- 网络中的链路状态可能经常发生变化，因此OSPF让每一个链路状态都带上一个32位的序号，序号越大状态就越新。

2. OSPF的五种分组类型

- 类型1，问候分组，用来发现和维持邻站的可达性。每隔10s要交换一次问候分组，以确定相邻路由器的可达性。
- 类型2，数据库描述分组，向邻站给出自己的链路状态数据库。
- 类型3，链路状态请求，向对方请求发送某些链路状态项目的详细信息。
- 类型4，链路状态更新分组，用洪泛法对全网更新链路状态。
- 类型5，链路状态确认，对链路更新分组确认。

OSPF 让每一个路由器用数据库描述分组和相邻路由器交换本数据库中已有的链路状态摘要信息。

其中摘要信息中，可以知道哪些路由器的链路状态信息已经写入了数据库。过程如下图。

![](https://pic.downk.cc/item/5e47a6df48b86553ee78671b.jpg)

网络运行过程中，只要一个路由器的链路状态发生变化，该路由器就要使用链路状态更新分组，用洪泛法向全网更新链路状态。OSPF使用的是**可靠的洪泛法**，在收到更新分组后要发送确认。

![](https://pic.downk.cc/item/5e47b11948b86553ee7aa74c.jpg)

### 4.5.4 外部网关协议BGP

> 边界网关协议BGP，BGP用于自治系统AS之间的环境。在自治系统AS之间交换“可达性”信息。例如，告诉相邻路由器，“到达目的网络N可经过自治系统ASx”

需要考虑的因素：

- 互联网规模太大，使得自治系统AS之间路由选择非常困难。
- 自治系统AS之间的路由选择必须考虑有关策略。例如，某些自治系统的限制。

因此，BGP只能力求寻找一条能够**到达目的网络且比较好的路由**，并非寻找一条最佳的路由。BGP协议交换路由信息的结点数量级是**自治系统个数的量级**，相比自治系统中的网络数少很多。

BGP解决距离向量路由选择算法中的“坏消息传播得慢”的问题。当某个路由器或者链路出故障时BGP发言人可以不止一个邻站获得路由信息，因此容易选择出新的路由。而距离向量算法往往不能给出正确的选择，这些算法不能指出哪些邻站到目的站的路由是独立的。

BGP-4的四种报文：

- OPEN报文，初始化与另一个BGP发言人的通信， 建立关系
- UPDATE报文，通告某一路由信息，以及列出要撤销的多条路由。
- KEEPALIVE报文，用来周期性地证实邻站的连通性。
- NOTIFICATION报文，用来发送检测到的差错。

<img src="https://pic.downk.cc/item/5e49ede348b86553eeff423a.jpg" style="zoom:80%;" />



### 4.5.5 路由器的构成

> 路由器是一种具有多个输入输出和多个输出端口的专用计算机，其任务是转发分组。路由器的转发分组正是网络层的主要工作。

1. 路由器的结构

   整个的路由器的结构可划分为两大部分 **路由选择** 、**分组转发** 。

    <img src="https://pic.downk.cc/item/5e49f06148b86553eeffbeec.jpg" style="zoom:80%;" />

    **分组转发和路由选择的区别：**
      转发表仅仅涉及到一个路由器，应当使查找过程最优化，可用特殊的硬件来实现。
   
      路由表是许多路由器共同协作的结果，应当对网络拓扑的变化的计算最优化，用软件算法来实现。
   
   
   
2. 交换结构
    ![](https://pic.downk.cc/item/5e4a054948b86553ee034b9f.jpg)

## 4.6 IPv6

> 解决IP地址耗尽的根本措施就是采用具有更大地址空间的新版本IP,IPv6

### 4.6.1 IPv6的基本首部
> IPv6仍然支持无连接的传送，将协议数据单元PDU称为分组，而不是IPv4的数据报。方便起见仍采用数据报这一名词。

主要变化：
a. 更大的地址空间。IPv6从IPv4的32位增大到128位，使地址空间增大了  2<sup>96</sup>倍。
b. 扩展的地址层次结构。
c. 灵活的首部格式。定义了许多可选的扩展首部，不仅比IPv4提供更多的功能，而且还可以提高路由器的处理效率（因为路由器对扩展的首部不进行处理）。
d. 改进的选项。允许数据报包含有选项的控制信息，可以包含一些新的选项。IPv6的首部长度是固定的，其选项放在有效负荷中。
e. 允许协议继续扩充。
f. 支持即插即用
g. 支持资源的预分配
h. 首部改为8字节对齐
![](https://pic.downk.cc/item/5e4a280d48b86553ee0a3e08.jpg)

- IPv6把原来IPv4首部中选项的功能都放在扩展首部中，并把扩展首部留给路径两端的源点和终点的主机来处理，大大提高了路由器的处理效率。

### 4.6.2 IPv6的地址

一个IPv6的数据报的目的地址可以是以下三种基本类型：

1. 单播。传统的点对点通信。
2. 多播。 一点对多点的通信，数据报发送到一组中所有计算机。 将广播看作是多播的一个特例。
3. 任播。任播的终点是一组计算机，但数据报只交付其中一个，通常是距离最近的一个。

- 为了使地址简洁，IPv6使用**冒号16进制记法** 
  允许0省略 0压缩记法，其次还可以结合使用点分十进制记法后缀，在IPv4向v6的转换阶段特别有用。CIDR斜线表示法仍然有用。
  ![](https://pic.downk.cc/item/5e4a36ec48b86553ee0db8b9.jpg)

![](https://pic.downk.cc/item/5e4a39b048b86553ee0e447b.jpg)

### 4.6.3 从IPv4向IPv6过渡

> 由于现在互联网规模太大，向IPv6过渡只能采用逐步演进的办法。IPv6系统必须能够接收和转发IPv4分组，并且能够为IPv4分组选择路由。

1. 双协议栈

   > 在完全过渡到v6之前，使一部分主机装有双协议栈：一个IPv4和一个IPv6。无论是v4还是v6都可以进行通信。表明双协议栈的主机具有两种IP地址v4和v6。

   ![](https://pic.downk.cc/item/5e4a3b8d48b86553ee0e9e73.jpg)

   

   需要注意的是：由于转发过程中，数据报的转换导致IPv6首部中的某些字段无法恢复。

   

2.  隧道技术

   > 这种方法要点就是在v6数据报要进入v4网络时，把v6数据报封装成v4的数据报的数据部分。相当于v6数据报就像在IPv4网络的隧道中传输没有发生什么变化。当离开v4隧道时，再把数据交给主机的v6协议栈。

   ![](https://pic.downk.cc/item/5e4a3c3e48b86553ee0ebfd9.jpg)



### 4.6.4 ICMPv6

> 给IPv6反馈差错信息，地址解析协议ARP和网际组管理协议IGMP的功能都已被合并到ICMPv6。

<img src="https://pic.downk.cc/item/5e4a470248b86553ee10e83b.jpg" style="zoom:80%;" />

## 4.7 IP多播

